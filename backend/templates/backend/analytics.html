{% extends 'backend/base.html' %} {% block content %}
<!-- sidebar -->
{% include 'backend/sidebar.html' %}
<div id="content-wrapper" class="d-flex flex-column">
    <!-- Main Content -->
    <div id="content">
        {% include 'backend/topbar.html' %}
        <div class="container-fluid">
            <h2>Analytics</h2>
            {% if customTables %}
            <div class="row">
                <div class="container-fluid">
                    <h3>Select a Table</h3>
                    <br />
                    {% for table in customTables %}
                    <div class="col col-2">
                        <div class="card bg-primary text-white shadow">
                            <div class="card-body">
                                {{ table.name }}
                                <!-- <div class="text-white-50 small">
                                        {{ campaign.created_at }}
                                    </div> -->
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="row">
                <div class="col">
                    <form class="form-inline">
                        <label class="my-1 mr-2">Function</label>
                        <select
                            class="custom-select my-1 mr-sm-2"
                            id="selectFunction"
                        >
                            <option value="sum">Sum</option>
                            <option value="mean">Mean</option>
                            <option value="median">Median</option>
                            <option value="min">Min</option>
                            <option value="max">Max</option>
                            <option value="T">Transpose</option>
                            <option value="groupby">Group By</option>
                            <option value="pivot">Pivot</option>
                        </select>

                        <label class="my-1 mr-2">Column</label>
                        <select
                            id="selectColumn"
                            class="custom-select my-1 mr-sm-2"
                        >
                        </select>

                        <button
                            id="applyFunction"
                            type="button"
                            class="btn btn-primary my-1"
                        >
                            Apply
                        </button>
                    </form>
                </div>
                <div class="col">
                    <div id="functionResult" class="mt-2"></div>
                </div>
            </div>
            <div class="row">
                <input
                    type="hidden"
                    id="customTableId"
                    value="{{ customTableId }}"
                />
                <div
                    style="display: block; position: absolute; height: 75%; width: 85%; overflow: scroll;"
                >
                    <table
                        class="table table-bordered dataTable"
                        id="dataTable"
                        cellspacing="0"
                        role="grid"
                        style="background: white;"
                    ></table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        if ($('#customTableId').val()) {
            loadTable(customTableId);
        }

        $('#applyFunction').click(function() {
            applyFunction(
                $('#customTableId').val(),
                $('#selectFunction').val(),
                $('#selectColumn').val()
            );
        });
    });

    function loadTable(customTableId) {
        $.post(
            '/api/analytics',
            { data: JSON.stringify({ customTableId: 4, functions: {} }) },
            function(response) {
                var table = response.table;
                var data = $.parseJSON(table.data);
                createTable(data);
            }
        );
    }

    function applyFunction(customTableId, fn, column) {
        var data = {
            customTableId: customTableId,
            functions: {}
        };
        data.functions[fn] = column;
        $.post('/api/analytics', { data: JSON.stringify(data) }, function(
            response
        ) {
            if (response.table) {
                console.log(response.table);
                $('#dataTable').empty();
                createTable($.parseJSON(response.table.data));
            } else {
                $('#functionResult').text(response.result);
            }
        });
    }

    function createTable(data) {
        $('#dataTable').append(
            "<thead><tr id='header' role='row'></tr></thead><tbody id='tableBody'></tbody>"
        );
        // populate columns
        var columns = Object.keys(data);
        columns.forEach(function(column) {
            $('#header').append(`<th>${column}</th>`);
            $('#selectColumn').append(
                `<option value="${column}">${column}</option>`
            );
        });

        // populate rows
        var rowIds = Object.keys(data[columns[0]]);
        rowIds.forEach(function(row) {
            var rowData = '<tr>';
            columns.forEach(function(col) {
                rowData += `<td>${data[col][row]}</td>`;
            });
            rowData += '</tr>';
            $('#tableBody').append(rowData);
        });
    }
</script>
{% endblock %}
